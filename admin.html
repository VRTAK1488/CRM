<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Админка — Vonyuchiy Veter CRM</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2>Vonyuchiy Veter CRM</h2>
        <p id="userRole"></p>
      </div>
      <ul class="nav-links">
        <li><a href="home.html">Главная</a></li>
        <li><a href="leads.html">Лиды</a></li>
        <li><a href="reminders.html">Напоминания</a></li>
        <li><a href="admin.html" class="active">Админка</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <div class="header">
        <h1>Администрирование</h1>
        <button class="logout-btn" onclick="logout()">Выйти</button>
      </div>

      <!-- Создание пользователя -->
      <div class="section">
        <div class="section-title">Создать пользователя</div>
        <div class="form-group">
          <label>Логин</label>
          <input type="text" id="newUsername" placeholder="Имя пользователя">
        </div>
        <div class="form-group">
          <label>Роль</label>
          <select id="newUserRole">
            <option value="manager">Менеджер</option>
            <option value="admin">Администратор</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="createUser()">Создать</button>
        <p id="userMessage" style="margin-top: 10px; color: var(--success);"></p>
      </div>

      <!-- Импорт лидов -->
      <div class="section">
        <div class="section-title">Импорт лидов (CSV)</div>
        <p>Формат: <code>Имя,Email,Телефон,Страна,Источник</code></p>
        <textarea id="csvData" placeholder="Вставьте CSV-данные" rows="6" style="width:100%; margin:10px 0;"></textarea>
        <button class="btn btn-primary" onclick="importLeads()">Импортировать</button>
        <p id="importMessage" style="margin-top: 10px; color: var(--success);"></p>
      </div>

      <!-- Логи -->
      <div class="section">
        <div class="section-title">Логи действий</div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Пользователь</th>
                <th>Действие</th>
                <th>Время</th>
              </tr>
            </thead>
            <tbody id="logsTable"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <script src="js/data.js"></script>
  <script src="js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (localStorage.getItem('role') !== 'admin') {
        window.location.href = 'home.html';
      }
      loadLogs();
    });

    function createUser() {
      const username = document.getElementById('newUsername').value.trim();
      const role = document.getElementById('newUserRole').value;
      const msg = document.getElementById('userMessage');
      if (!username) return;
      if (addUser(username, role)) {
        msg.textContent = `✅ Пользователь ${username} создан`;
        document.getElementById('newUsername').value = '';
      } else {
        msg.textContent = '❌ Такой логин уже существует';
        msg.style.color = 'var(--danger)';
      }
    }

    function importLeads() {
      const csv = document.getElementById('csvData').value.trim();
      const msg = document.getElementById('importMessage');
      if (!csv) return;
      try {
        const lines = csv.split('\n').filter(l => l.trim());
        let count = 0;
        for (let i = 0; i < lines.length; i++) {
          const [name, email, phone, country, source] = lines[i].split(',').map(s => s.trim());
          if (name) {
            addClient({ name, email, phone, country, source, manager: 'admin', status: 'new', reminder: '' });
            count++;
          }
        }
        msg.textContent = `✅ Импортировано ${count} лидов`;
        document.getElementById('csvData').value = '';
      } catch (e) {
        msg.textContent = '❌ Ошибка формата';
        msg.style.color = 'var(--danger)';
      }
    }

    function loadLogs() {
      const logs = JSON.parse(localStorage.getItem('logs') || '[]').reverse().slice(0, 20);
      const tbody = document.getElementById('logsTable');
      tbody.innerHTML = logs.map(l => `
        <tr>
          <td>${l.user}</td>
          <td>${l.action} ${l.details ? `(${l.details})` : ''}</td>
          <td>${new Date(l.timestamp).toLocaleString()}</td>
        </tr>
      `).join('');
    }
  </script>
</body>
</html>